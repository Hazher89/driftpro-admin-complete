<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Avdelinger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCyE4S4B5q2JLdtaTtr8kVVvg8y-3Zm7ZE",
            authDomain: "driftpro-40ccd.firebaseapp.com",
            projectId: "driftpro-40ccd",
            storageBucket: "driftpro-40ccd.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let currentCompanyId = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                console.log('User logged in:', user.email);
                loadUserData();
            } else {
                console.log('No user logged in');
                window.location.href = '/';
            }
        });

        async function loadUserData() {
            try {
                console.log('Loading user data for:', currentUser.uid);
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    console.error('User document not found');
                    document.getElementById('status').innerHTML = '<p class="text-red-500">Brukerdata ikke funnet</p>';
                    return;
                }
                
                const userData = userDoc.data();
                currentCompanyId = userData.companyId;
                
                console.log('User data loaded:', userData);
                console.log('Company ID:', currentCompanyId);
                
                document.getElementById('status').innerHTML = '<p class="text-green-500">Brukerdata lastet: ' + currentCompanyId + '</p>';
                loadDepartments();
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('status').innerHTML = '<p class="text-red-500">Feil: ' + error.message + '</p>';
            }
        }

        async function loadDepartments() {
            try {
                console.log('Loading departments for company:', currentCompanyId);
                
                if (!currentCompanyId) {
                    console.error('No company ID found');
                    document.getElementById('departments').innerHTML = '<p class="text-red-500">Ingen bedrift funnet</p>';
                    return;
                }
                
                const snapshot = await db.collection('departments')
                    .where('companyId', '==', currentCompanyId)
                    .get();
                
                console.log('Snapshot size:', snapshot.size);
                
                const departments = [];
                snapshot.forEach(doc => {
                    departments.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Loaded departments:', departments);
                
                if (departments.length === 0) {
                    document.getElementById('departments').innerHTML = '<p class="text-blue-500">Ingen avdelinger funnet for denne bedriften</p>';
                } else {
                    document.getElementById('departments').innerHTML = '<p class="text-green-500">Fant ' + departments.length + ' avdelinger</p>';
                }
            } catch (error) {
                console.error('Error loading departments:', error);
                document.getElementById('departments').innerHTML = '<p class="text-red-500">Feil ved lasting av avdelinger: ' + error.message + '</p>';
            }
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = '/';
            });
        }
    </script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Test - Avdelinger</h1>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Status</h2>
            <div id="status">Laster...</div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Avdelinger</h2>
            <div id="departments">Laster avdelinger...</div>
        </div>
        
        <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded">Logg Ut</button>
    </div>
</body>
</html>
